<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Diary - Tell Your Story</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Noto+Serif+TC:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-dark: #2a1f1a; --bg-medium: #3d2e26; --bg-light: #4a3830;
            --gold: #c9a227; --gold-light: #e8d5a3; --rose-gold: #d4a574;
            --pink: #e8a0a0; --pink-bright: #ff6b9d;
            --text-gold: #d4b896; --text-light: #f5e6d3;
        }
        body {
            font-family: 'Noto Serif TC', serif;
            background: linear-gradient(145deg, #1a1210 0%, #2a1f1a 50%, #1a1210 100%);
            min-height: 100vh; display: flex; justify-content: center; align-items: center;
            padding: 20px; overflow: hidden;
        }
        .app-container {
            width: 100%; max-width: 900px; height: 90vh; max-height: 700px;
            background: linear-gradient(180deg, #3d2e26 0%, #2a1f1a 100%);
            border-radius: 24px; border: 3px solid #5a4a3a;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.1);
            display: flex; flex-direction: column; position: relative; overflow: hidden;
        }
        .header { padding: 18px 28px; display: flex; justify-content: space-between; align-items: center; }
        .logo {
            font-family: 'Cinzel Decorative', cursive; font-size: 2rem; font-weight: 700;
            color: var(--gold-light);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5), 0 0 30px rgba(212,165,116,0.3);
        }
        .test-mode-badge {
            background: var(--pink-bright); color: white; padding: 4px 10px;
            border-radius: 12px; font-size: 0.7rem; font-weight: 600;
        }
        .toolbar {
            position: absolute; right: 18px; top: 75px;
            display: flex; flex-direction: column; gap: 7px; z-index: 10;
        }
        .tool-btn {
            width: 40px; height: 40px;
            background: linear-gradient(145deg, #4a3830, #3d2e26);
            border: 2px solid #6a5a4a; border-radius: 9px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; opacity: 0.7; transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); position: relative;
        }
        .tool-btn:hover { transform: translateY(-2px); opacity: 1; }
        .tool-btn:hover .tooltip { opacity: 1; transform: translateX(-10px); }
        .tool-btn.active { opacity: 1; border-color: var(--gold); }
        .tool-btn svg { width: 18px; height: 18px; fill: var(--rose-gold); }
        .tool-btn .emoji { font-size: 18px; }
        .tooltip {
            position: absolute; right: 50px; background: var(--bg-medium);
            color: var(--text-gold); padding: 5px 9px; border-radius: 5px;
            font-size: 0.7rem; white-space: nowrap; opacity: 0;
            transition: all 0.3s ease; pointer-events: none; border: 1px solid #5a4a3a;
        }
        .dropdown-menu {
            position: absolute; right: 50px; top: 0;
            background: var(--bg-medium); border: 1px solid #5a4a3a;
            border-radius: 8px; overflow: hidden; display: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4); min-width: 160px;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            padding: 8px 12px; color: var(--text-gold); cursor: pointer;
            font-size: 0.75rem; transition: background 0.2s; border-bottom: 1px solid #4a3a30;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: var(--bg-light); }
        .dropdown-item.active { background: var(--gold); color: var(--bg-dark); }
        
        .name-input-popup { padding: 10px; min-width: 160px; }
        .name-input-popup label { display: block; color: var(--text-gold); font-size: 0.7rem; margin-bottom: 5px; }
        .name-input-popup input {
            width: 100%; padding: 7px 9px; border: 1px solid #5a4a3a;
            background: var(--bg-dark); color: var(--text-light);
            border-radius: 5px; font-size: 0.8rem; margin-bottom: 7px;
        }
        .name-input-popup button {
            width: 100%; padding: 7px; background: var(--gold);
            border: none; border-radius: 5px; color: var(--bg-dark);
            font-weight: 600; cursor: pointer; font-size: 0.75rem;
        }
        
        .chat-area {
            flex: 1; padding: 0 70px 12px 120px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
        }
        .chat-area::-webkit-scrollbar { width: 5px; }
        .chat-area::-webkit-scrollbar-track { background: var(--bg-dark); border-radius: 3px; }
        .chat-area::-webkit-scrollbar-thumb { background: var(--bg-light); border-radius: 3px; }
        
        .message {
            max-width: 85%; display: inline-block;
            padding: 11px 16px; border-radius: 14px;
            animation: messageSlide 0.4s ease-out; line-height: 1.6;
            word-wrap: break-word; overflow-wrap: break-word; white-space: pre-wrap;
        }
        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.ai {
            align-self: flex-start;
            background: linear-gradient(145deg, #4a3830, #3d2e26);
            border: 2px solid #5a4a3a; color: var(--text-light);
        }
        .message.user {
            align-self: flex-end;
            background: linear-gradient(145deg, #6a4a4a, #5a3a3a);
            border: 2px solid #8a6a6a; color: var(--text-light);
        }
        
        .diary-ready-btn {
            align-self: center;
            background: linear-gradient(145deg, var(--gold), #a88420);
            border: none; border-radius: 20px; padding: 12px 24px;
            color: var(--bg-dark); font-weight: 600; font-size: 0.95rem;
            cursor: pointer; margin-top: 10px;
            box-shadow: 0 4px 16px rgba(201,162,39,0.4);
            animation: pulse 2s infinite;
        }
        .diary-ready-btn:hover { transform: scale(1.05); }
        
        .diary-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85); display: flex;
            justify-content: center; align-items: center; z-index: 100;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .diary-book {
            width: 90%; max-width: 750px; max-height: 85vh;
            background: linear-gradient(145deg, #4a3a2a, #3a2a1a);
            border-radius: 8px; position: relative; overflow: hidden;
            box-shadow: 0 0 60px rgba(0,0,0,0.8), 0 0 100px rgba(201,162,39,0.2);
        }
        .diary-book::before {
            content: ''; position: absolute; left: 50%; top: 0; bottom: 0;
            width: 3px; background: linear-gradient(180deg, #2a1a10, #5a4a3a, #2a1a10);
            transform: translateX(-50%);
        }
        .diary-header {
            background: linear-gradient(90deg, #5a4a3a, #6a5a4a, #5a4a3a);
            padding: 12px 20px; text-align: center;
            border-bottom: 2px solid #7a6a5a;
        }
        .diary-header h2 {
            font-family: 'Cinzel Decorative', cursive; color: var(--gold-light);
            font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 3px;
        }
        .diary-close {
            position: absolute; top: 10px; right: 15px;
            background: none; border: none; color: var(--text-gold);
            font-size: 1.6rem; cursor: pointer; opacity: 0.7;
        }
        .diary-close:hover { opacity: 1; }
        
        .diary-content {
            display: flex; max-height: calc(85vh - 55px); overflow: hidden;
        }
        .diary-page {
            flex: 1; padding: 20px; overflow-y: auto;
            background: linear-gradient(135deg, #f5e6d3 0%, #e8d5c0 100%);
            color: #3a2a1a; line-height: 1.8; font-size: 0.9rem;
        }
        .diary-page:first-child { border-right: 1px solid #d4c4b0; }
        .diary-page h3 {
            color: #5a4a3a; margin-bottom: 12px; font-size: 1.05rem;
            border-bottom: 1px solid #c4b4a0; padding-bottom: 8px;
            text-align: center;
        }
        .diary-page h3.ai-title { color: #8a5a5a; }
        .diary-page p { white-space: pre-wrap; }
        .diary-page .copy-btn {
            margin-top: 12px; padding: 8px 12px;
            background: #5a4a3a; border: none; border-radius: 50%;
            color: #f5e6d3; font-size: 0.9rem; cursor: pointer;
            position: relative; width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
        }
        .diary-page .copy-btn:hover { background: #6a5a4a; }
        .diary-page .copy-btn:hover::after {
            content: 'Copy'; position: absolute; bottom: -24px; left: 50%;
            transform: translateX(-50%); background: #3a2a1a; color: #f5e6d3;
            padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; white-space: nowrap;
        }
        
        .cat-mascot {
            position: absolute; left: 10px; bottom: 85px;
            font-size: 65px; z-index: 5;
            filter: drop-shadow(0 4px 12px rgba(232,160,160,0.4));
        }
        .input-area {
            padding: 12px 20px; display: flex; align-items: center; gap: 8px;
            background: linear-gradient(180deg, transparent, rgba(0,0,0,0.2));
        }
        .input-container {
            flex: 1; display: flex; align-items: center;
            background: linear-gradient(145deg, #3d2e26, #2a1f1a);
            border: 2px solid #5a4a3a; border-radius: 20px; padding: 9px 14px;
            margin-left: 85px;
        }
        .input-container input {
            flex: 1; background: transparent; border: none; outline: none;
            color: var(--text-light); font-size: 0.85rem; font-family: 'Noto Serif TC', serif;
        }
        .input-container input::placeholder { color: rgba(212,184,150,0.5); }
        .mic-btn, .send-btn {
            width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            background: linear-gradient(145deg, #4a3830, #3d2e26);
            border: 3px solid #6a5a4a; transition: all 0.3s ease;
        }
        .mic-btn:hover, .send-btn:hover { transform: scale(1.05); }
        .mic-btn.recording {
            background: linear-gradient(145deg, #ff6b9d, #d4547a);
            border-color: #ff8ab5; animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(255,107,157,0.5); }
            50% { box-shadow: 0 4px 30px rgba(255,107,157,0.7); }
        }
        .mic-btn svg, .send-btn svg { width: 20px; height: 20px; fill: var(--rose-gold); }
        .mic-btn.recording svg { fill: white; }
        .mic-btn:disabled, .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { display: flex; gap: 4px; padding: 8px; }
        .loading span {
            width: 6px; height: 6px; background: var(--rose-gold);
            border-radius: 50%; animation: bounce 1.4s ease-in-out infinite both;
        }
        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .status-bar {
            position: absolute; top: 16px; right: 70px;
            font-size: 0.65rem; color: var(--text-gold); opacity: 0.7;
        }
        
        @media (max-width: 768px) {
            .app-container { height: 95vh; max-height: none; border-radius: 16px; }
            .logo { font-size: 1.3rem; }
            .chat-area { padding: 0 60px 12px 12px; }
            .toolbar { right: 6px; top: 60px; }
            .tool-btn { width: 34px; height: 34px; }
            .cat-mascot { font-size: 40px; left: 6px; bottom: 75px; }
            .input-container { margin-left: 0; }
            .diary-content { flex-direction: column; }
            .diary-page:first-child { border-right: none; border-bottom: 1px solid #d4c4b0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // ===== 3ÂÄã API Key Ëº™ÊµÅ‰ΩøÁî® =====
        const API_KEYS = [
        ];
        let currentKeyIndex = 0;

        const ELEVENLABS_API_KEY = '';
        // ÊîπÁî®Â•≥ËÅ≤ - Sarah (ÁîúÁæéÂèØÊÑõ)
        const ELEVENLABS_VOICE_ID = 'EXAVITQu4vr4xnSDxMaL'; // Sarah - sweet female voice
        const GEMINI_MODEL = 'gemini-2.0-flash';

        // ===== Ê∏¨Ë©¶Ê®°ÂºèÂõ∫ÂÆöÂ∞çË©± =====
        const TEST_CONVERSATIONS = {
            'zh-TW': [
                { user: '‰ªäÂ§©ÊòØÊàëÁöÑÁîüÊó•', ai: 'ÁîüÊó•Âø´Ê®ÇÔºÅ‰ªäÂ§©Êúâ‰ªÄÈ∫ºÁâπÂà•ÁöÑÊÖ∂Á•ùÂóéÔºü' },
                { user: 'ÊúãÂèãÂ∏∂ÊàëÂéªÂêÉÂ§ßÈ§ê', ai: 'ÁúüÊ£íÔºÅÊòØÂéª‰ªÄÈ∫ºÊ®£ÁöÑÈ§êÂª≥Âë¢Ôºü' },
                { user: '‰∏ÄÂÆ∂ÂæàÊºÇ‰∫ÆÁöÑËä±ÂúíÈ§êÂª≥', ai: 'ËÅΩËµ∑‰æÜÂ•ΩÊµ™Êº´ÔºÅÊúâ‰ªÄÈ∫ºËÆì‰Ω†Âç∞Ë±°Ê∑±ÂàªÁöÑÂóéÔºü' },
                { user: '‰ªñÂÄëÈÇÑÈªû‰∫ÜËçâËéìËõãÁ≥ïÁµ¶Êàë', ai: 'Â§™Ë≤ºÂøÉ‰∫ÜÔºÅÊÉ≥ÊääÈÄôÁæéÂ•ΩÁöÑ‰∏ÄÂ§©Ë®òÈåÑ‰∏ã‰æÜÂóéÔºü' },
            ],
            'en': [
                { user: "Today is my birthday", ai: "Happy birthday! Any special celebration today?" },
                { user: "Friends took me to dinner", ai: "That's wonderful! What kind of restaurant?" },
                { user: "A beautiful garden restaurant", ai: "Sounds lovely! Anything memorable?" },
                { user: "They ordered strawberry cake for me", ai: "So sweet! Want to record this beautiful day?" },
            ]
        };

        const TEST_DIARY = {
            'zh-TW': {
                diary: `‰ªäÂ§©ÊòØÊàëÁöÑÁîüÊó•Ôºå‰∏ÄÂÄãËÆìÊàëÊÑüÂà∞ÁÑ°ÊØîÂπ∏Á¶èÁöÑÊó•Â≠ê„ÄÇ

ÊàëÁöÑÂ•ΩÊúãÂèãÂÄëÂ∏∂ÊàëÂéª‰∫Ü‰∏ÄÂÆ∂ÂæàÊºÇ‰∫ÆÁöÑËä±ÂúíÈ§êÂª≥ÊÖ∂Á•ù„ÄÇÈÇ£Ë£°ÁöÑÁí∞Â¢ÉÁúüÁöÑÂæàÁæéÔºåËÆìÊï¥ÂÄãÁî®È§êÈ´îÈ©óÈÉΩËÆäÂæóÁâπÂà•Ëµ∑‰æÜ„ÄÇÊõ¥ËÆìÊàëÊÑüÂãïÁöÑÊòØÔºå‰ªñÂÄëÈÇÑÁâπÂà•ÁÇ∫ÊàëÈªû‰∫ÜËçâËéìËõãÁ≥ï„ÄÇ

ÁúãËëóÁúºÂâçÁöÑËõãÁ≥ïÂíåË∫´ÈÇäÁöÑÊúãÂèãÂÄëÔºåÊàëÂøÉË£°ÊπßËµ∑‰∏ÄËÇ°ÊöñÊµÅ„ÄÇÈÄô‰∫õÈÉΩÊòØ‰∏ÄÁõ¥Èô™‰º¥ÊàëÁöÑÂ•ΩÊúãÂèãÔºå‰ªñÂÄëÁî®ÈÄôÊ®£ÁöÑÊñπÂºèÁÇ∫ÊàëÊÖ∂ÁîüÔºåËÆìÊàëÊÑüÂèóÂà∞ÊªøÊªøÁöÑÊÑõ„ÄÇ

ÊàëÁúüÁöÑË¶∫ÂæóËá™Â∑±ÂæàÂπ∏ÈÅãÔºåËÉΩÊìÅÊúâÈÄôÊ®£‰∏ÄÁæ§ÁúüÂøÉÂæÖÊàëÁöÑÊúãÂèã„ÄÇÈÄô‰ªΩÊÉÖË™ºÊòØÊàëÊúÄÁèçË≤¥ÁöÑÂØ∂Ëóè„ÄÇ

‰ªäÂ§©ÁöÑÁîüÊó•ÔºåÂõ†ÁÇ∫Êúâ‰ªñÂÄëÔºåËÆäÂæóÊ†ºÂ§ñÊ∫´ÊöñËÄåÈõ£Âøò„ÄÇ`,
                letter: `Ë¶™ÊÑõÁöÑÊúãÂèãÔºå

ËÆÄËëó‰Ω†ÁöÑÁîüÊó•Êó•Ë®òÔºåÊàë‰πüÊÑüÂèóÂà∞‰∫ÜÈÇ£‰ªΩÊ∫´ÊöñÂíåÂπ∏Á¶è„ÄÇ

Ëä±ÂúíÈ§êÂª≥„ÄÅËçâËéìËõãÁ≥ï„ÄÅÈÇÑÊúâÂ•ΩÊúãÂèã‚Äî‚ÄîÈÄô‰∫õÁµÑÊàê‰∫Ü‰∏ÄÂÄãÂ§öÈ∫ºÁæéÂ•ΩÁöÑÁîüÊó•ÂïäÔºÅËÉΩË¢´ÈÄôÊ®£ÁèçÊÉúÂíåÊÑõËëóÔºåÁúüÁöÑÊòØÂæàÂπ∏Á¶èÁöÑ‰∫ã„ÄÇ

È°ò‰Ω†ÂÄëÁöÑÂèãË™ºÊ∞∏ÈÅ†ÁîúËúúÊ∫´Êöñ„ÄÇ

ÁîüÊó•Âø´Ê®ÇÔºÅ

Â∞èÁ≤â`
            },
            'en': {
                diary: `Today is my birthday, a day filled with happiness.

My good friends took me to a beautiful garden restaurant to celebrate. The atmosphere was wonderful, making the whole experience special. What touched me even more was that they ordered a strawberry cake for me.

Looking at the cake and my friends around me, warmth filled my heart. These are friends who have always been there for me, celebrating my birthday in such a thoughtful way.

I truly feel lucky to have such genuine friends. This friendship is my most precious treasure.

Today's birthday, because of them, became exceptionally warm and unforgettable.`,
                letter: `Dear friend,

Reading your birthday diary, I can feel that warmth and happiness too.

A garden restaurant, strawberry cake, and good friends‚Äîwhat a beautiful birthday! Being cherished like this is truly a blessing.

May your friendship stay sweet and warm forever.

Happy Birthday!

Pinky`
            }
        };

        const TRANSLATIONS = {
            en: {
                greeting: (userName, aiName) => `Hi ${userName}! How was your day?`,
                placeholder: "Type or tap mic...",
                listening: "Listening...",
                generating: "Writing diary... ‚ú®",
                myDiary: "üìñ My Diary",
                aiLetter: (aiName) => `üíï From ${aiName}`,
                copied: "‚úÖ Copied!",
                needMore: "Tell me more about today!",
                error: "Error: ",
                viewDiary: "‚ú® Diary Ready! Tap to View",
                save: "Save",
                testMode: "TEST",
                newDiary: "New Diary"
            },
            'zh-TW': {
                greeting: (userName, aiName) => `Âó® ${userName}ÔºÅ‰ªäÂ§©ÈÅéÂæóÂ¶Ç‰ΩïÔºü`,
                placeholder: "Ëº∏ÂÖ•ÊàñÊåâÈ∫•ÂÖãÈ¢®...",
                listening: "ËÅÜËÅΩ‰∏≠...",
                generating: "Ê≠£Âú®ÂØ´Êó•Ë®ò... ‚ú®",
                myDiary: "üìñ ÊàëÁöÑÊó•Ë®ò",
                aiLetter: (aiName) => `üíï ${aiName}ÁöÑÂõû‰ø°`,
                copied: "‚úÖ Â∑≤Ë§áË£ΩÔºÅ",
                needMore: "ÂÜçÂ§öÂëäË®¥Êàë‰∏Ä‰∫õÂêßÔºÅ",
                error: "Âá∫ÈåØÔºö",
                viewDiary: "‚ú® Êó•Ë®òÂØ´Â•Ω‰∫ÜÔºÅÈªûÊàëÊü•Áúã",
                save: "ÂÑ≤Â≠ò",
                testMode: "Ê∏¨Ë©¶",
                newDiary: "Êñ∞Êó•Ë®ò"
            }
        };

        const CAT_EMOTIONS = { happy: 'üò∫', sad: 'üòø', thinking: 'ü§î', love: 'üòª' };

        function VoiceDiary() {
            const [testMode, setTestMode] = useState(true);
            const [testStep, setTestStep] = useState(0);
            // È†êË®≠Ëã±ÊñáÁµ¶Ë©ïÂØ©
            const [lang, setLang] = useState('en');
            const [showLangMenu, setShowLangMenu] = useState(false);
            const [showAiNameInput, setShowAiNameInput] = useState(false);
            const [showUserNameInput, setShowUserNameInput] = useState(false);
            const [aiName, setAiName] = useState('Pinky');
            const [userName, setUserName] = useState('Friend');
            const [tempName, setTempName] = useState('');
            const t = TRANSLATIONS[lang];
            
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [catEmotion, setCatEmotion] = useState('happy');
            const [generatedDiary, setGeneratedDiary] = useState(null);
            const [aiReverseDiary, setAiReverseDiary] = useState(null);
            const [showDiaryModal, setShowDiaryModal] = useState(false);
            const [conversationHistory, setConversationHistory] = useState([]);
            const [statusMessage, setStatusMessage] = useState('');
            const [isSpeaking, setIsSpeaking] = useState(false);
            
            const chatAreaRef = useRef(null);
            const recognitionRef = useRef(null);
            const silenceTimerRef = useRef(null);

            // ÈáçÁΩÆÂ∞çË©±ÈñãÂßãÊñ∞Êó•Ë®ò
            const resetConversation = () => {
                setMessages([{ role: 'ai', content: t.greeting(userName, aiName) }]);
                setConversationHistory([]);
                setGeneratedDiary(null);
                setAiReverseDiary(null);
                setTestStep(0);
                setCatEmotion('happy');
            };

            useEffect(() => {
                const localAiName = lang === 'zh-TW' ? 'Â∞èÁ≤â' : 'Pinky';
                const localUserName = lang === 'zh-TW' ? 'ÊúãÂèã' : 'Friend';
                setAiName(localAiName);
                setUserName(localUserName);
                setMessages([{ role: 'ai', content: TRANSLATIONS[lang].greeting(localUserName, localAiName) }]);
                setTestStep(0);
                setGeneratedDiary(null);
                setAiReverseDiary(null);
                setConversationHistory([]);
            }, [lang]);

            useEffect(() => {
                if (messages.length === 1 && messages[0].role === 'ai') {
                    setMessages([{ role: 'ai', content: t.greeting(userName, aiName) }]);
                }
            }, [userName, aiName]);

            useEffect(() => {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = lang === 'zh-TW' ? 'zh-TW' : 'en-US';
                    recognitionRef.current.onresult = (event) => {
                        clearTimeout(silenceTimerRef.current);
                        let finalTranscript = '', interimTranscript = '';
                        for (let i = 0; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) finalTranscript += transcript;
                            else interimTranscript += transcript;
                        }
                        setInputText(finalTranscript + interimTranscript);
                        silenceTimerRef.current = setTimeout(() => stopRecording(), 3000);
                    };
                    recognitionRef.current.onstart = () => setStatusMessage('üé§');
                    recognitionRef.current.onend = () => { setStatusMessage(''); setIsRecording(false); };
                    recognitionRef.current.onerror = (e) => { if (e.error !== 'no-speech') setStatusMessage('!'); setIsRecording(false); };
                }
                return () => { if (recognitionRef.current) recognitionRef.current.stop(); };
            }, [lang]);

            useEffect(() => {
                if (chatAreaRef.current) chatAreaRef.current.scrollTop = chatAreaRef.current.scrollHeight;
            }, [messages, generatedDiary]);

            const stopRecording = () => {
                if (recognitionRef.current && isRecording) {
                    recognitionRef.current.stop(); setIsRecording(false);
                    clearTimeout(silenceTimerRef.current); setCatEmotion('happy'); setStatusMessage('');
                }
            };
            const toggleRecording = () => {
                if (isSpeaking) return;
                if (isRecording) { stopRecording(); return; }
                if (recognitionRef.current) {
                    recognitionRef.current.lang = lang === 'zh-TW' ? 'zh-TW' : 'en-US';
                    setIsRecording(true); setCatEmotion('thinking'); setInputText('');
                    recognitionRef.current.start();
                }
            };

            const getNextApiKey = () => {
                const key = API_KEYS[currentKeyIndex];
                currentKeyIndex = (currentKeyIndex + 1) % API_KEYS.length;
                return key;
            };

            const callGeminiAPI = async (prompt) => {
                const apiKey = getNextApiKey();
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { temperature: 0.8, maxOutputTokens: 2048 }
                        })
                    }
                );
                const data = await response.json();
                if (!response.ok) throw new Error(data.error?.message || `HTTP ${response.status}`);
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            };

            // Ë™ûÈü≥Ôºö‰ΩøÁî®Â•≥ËÅ≤ + Âä†Âø´Ë™ûÈÄü
            const speakText = async (text) => {
                try {
                    if (isRecording) stopRecording();
                    setIsSpeaking(true);
                    const shortText = text.length > 60 ? text.substring(0, 60) : text;
                    const response = await fetch(
                        `https://api.elevenlabs.io/v1/text-to-speech/${ELEVENLABS_VOICE_ID}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'xi-api-key': ELEVENLABS_API_KEY },
                            body: JSON.stringify({
                                text: shortText,
                                model_id: 'eleven_flash_v2_5',
                                voice_settings: { 
                                    stability: 0.3,
                                    similarity_boost: 0.85,
                                    style: 0.7,
                                    use_speaker_boost: true
                                }
                            })
                        }
                    );
                    if (response.ok) {
                        const blob = await response.blob();
                        const audio = new Audio(URL.createObjectURL(blob));
                        audio.playbackRate = 1.25; // Âä†ÈÄüÊí≠Êîæ
                        audio.onended = () => setIsSpeaking(false);
                        audio.onerror = () => setIsSpeaking(false);
                        audio.play();
                    } else { setIsSpeaking(false); }
                } catch (e) { setIsSpeaking(false); }
            };

            const sendMessage = async () => {
                if (!inputText.trim() || isLoading) return;
                const userMessage = inputText.trim();
                setInputText(''); setIsLoading(true); setCatEmotion('thinking');

                const newMessages = [...messages, { role: 'user', content: userMessage }];
                setMessages(newMessages);
                const newHistory = [...conversationHistory, { role: 'user', content: userMessage }];
                setConversationHistory(newHistory);

                const diaryKeywords = ['ÁîüÊàêÊó•Ë®ò', 'ÂØ´Êó•Ë®ò', 'Êï¥ÁêÜÊó•Ë®ò', 'Ë®òÈåÑ', 'Êó•Ë®ò', 'write diary', 'diary'];
                if (diaryKeywords.some(k => userMessage.toLowerCase().includes(k))) {
                    await generateDiary();
                    return;
                }

                // ===== ‰øÆÊ≥ï BÔºöÊ∏¨Ë©¶Ê®°ÂºèËµ∞ÂÆå 4 Ëº™ÂæåÔºåÁî®Êà∂Ëº∏ÂÖ•‰ªª‰ΩïÊù±Ë•øÈÉΩÁõ¥Êé•ÁîüÊàêÊó•Ë®ò =====
                // ÔºàÂõ†ÁÇ∫Á¨¨ 4 Ëº™ AI Â∑≤Á∂ìÂïè‰∫Ü„ÄåÊÉ≥Ë®òÈåÑ‰∏ã‰æÜÂóéÔºü„ÄçÔºåÁî®Êà∂ÂõûÁ≠î‰ªª‰ΩïËÇØÂÆöÈÉΩÊáâËß∏ÁôºÊó•Ë®òÔºâ
                if (testMode && testStep >= TEST_CONVERSATIONS[lang].length) {
                    await generateDiary();
                    return;
                }

                if (testMode && testStep < TEST_CONVERSATIONS[lang].length) {
                    const currentStep = testStep; // Ë®ò‰ΩèÁï∂ÂâçÊ≠•È©ü
                    setTimeout(() => {
                        const response = TEST_CONVERSATIONS[lang][currentStep].ai;
                        setMessages([...newMessages, { role: 'ai', content: response }]);
                        setConversationHistory([...newHistory, { role: 'ai', content: response }]);
                        setCatEmotion('happy');
                        setTestStep(currentStep + 1);
                        speakText(response);
                        setIsLoading(false);

                        // ===== ‰øÆÊ≥ï AÔºöÊúÄÂæå‰∏ÄËº™Â∞çË©±ÂæåÔºåËá™ÂãïÂª∂ÈÅ≤ 2 ÁßíËß∏ÁôºÊó•Ë®òÁîüÊàê =====
                        if (currentStep + 1 >= TEST_CONVERSATIONS[lang].length) {
                            setTimeout(() => {
                                generateDiary();
                            }, 2000);
                        }
                    }, 600);
                    return;
                }

                try {
                    const context = newHistory.slice(-4).map(m => `${m.role === 'user' ? userName : aiName}: ${m.content}`).join('\n');
                    const promptLang = lang === 'zh-TW' ? 'Áî®ÁπÅÈ´î‰∏≠ÊñáÔºåÁ∞°Áü≠ÂõûÊáâ„ÄÇ' : 'Respond briefly in English.';
                    const prompt = `${aiName} is a warm diary coach. ${promptLang} Respond in 1-2 sentences, then ask one question.\n\n${context}\n\n${userName}: ${userMessage}\n\n${aiName}:`;
                    const aiResponse = await callGeminiAPI(prompt);
                    setMessages([...newMessages, { role: 'ai', content: aiResponse }]);
                    setConversationHistory([...newHistory, { role: 'ai', content: aiResponse }]);
                    setCatEmotion('happy');
                    speakText(aiResponse);
                } catch (error) {
                    setMessages([...newMessages, { role: 'ai', content: t.error + error.message }]);
                    setCatEmotion('sad');
                }
                setIsLoading(false);
            };

            const generateDiary = async () => {
                setIsLoading(true); setCatEmotion('thinking');
                setMessages(prev => [...prev, { role: 'ai', content: t.generating }]);

                if (testMode) {
                    setTimeout(() => {
                        setGeneratedDiary(TEST_DIARY[lang].diary);
                        setAiReverseDiary(TEST_DIARY[lang].letter);
                        setCatEmotion('love');
                        setIsLoading(false);
                    }, 1200);
                    return;
                }

                try {
                    const context = conversationHistory.map(m => `${m.role === 'user' ? userName : aiName}: ${m.content}`).join('\n');
                    const diaryLang = lang === 'zh-TW' ? 'Áî®ÁπÅÈ´î‰∏≠ÊñáÂØ´' : 'Write in English';
                    const diary = await callGeminiAPI(`${diaryLang}„ÄÇÁÇ∫${userName}ÂØ´Êó•Ë®òÔºà300Â≠óÔºâ„ÄÇÂè™Áî®Â∞çË©±ÂÖßÂÆπÔºå‰∏çÊ∑ªÂä†Á¥∞ÁØÄÔºåÁî®Á¨¨‰∏Ä‰∫∫Á®±ÔºåÊ∫´ÊöñË™ûË™ø„ÄÇ\n\nÂ∞çË©±Ôºö${context}\n\nÊó•Ë®òÔºö`);
                    setGeneratedDiary(diary);
                    const reverse = await callGeminiAPI(`${diaryLang}„ÄÇ‰Ω†ÊòØ${aiName}ÔºåÂØ´Âõû‰ø°Ôºà100Â≠óÔºâ„ÄÇÂè™ÂõûÊáâÊó•Ë®òÂÖßÂÆπÔºåË°®ÈÅîÈºìÂãµ„ÄÇ\n\nÊó•Ë®òÔºö${diary}\n\nÂõû‰ø°Ôºö`);
                    setAiReverseDiary(reverse);
                    setCatEmotion('love');
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'ai', content: t.error + error.message }]);
                    setCatEmotion('sad');
                }
                setIsLoading(false);
            };

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text);
                setStatusMessage(t.copied);
                setTimeout(() => setStatusMessage(''), 2000);
            };

            const closeAllMenus = () => { setShowLangMenu(false); setShowAiNameInput(false); setShowUserNameInput(false); };

            const toolbarItems = [
                { id: 'lang', icon: 'M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z', tip: 'Language' },
                { id: 'voice', icon: 'M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z', tip: 'Voice (Soon)' },
                { id: 'gallery', icon: 'M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z', tip: 'Gallery (Soon)' },
                { id: 'archive', icon: 'M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z', tip: 'Archive (Soon)' },
                { id: 'export', icon: 'M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z', tip: 'Export (Soon)' },
                { id: 'aiName', icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z', tip: 'AI Name' },
                { id: 'userName', icon: 'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z', tip: 'Your Name' },
                { id: 'reset', emoji: 'üßπ', tip: 'New Diary' },
            ];

            return (
                <div className="app-container">
                    <div className="header">
                        <div className="logo">Voice Diary</div>
                        {testMode && <span className="test-mode-badge">{t.testMode}</span>}
                        {statusMessage && <div className="status-bar">{statusMessage}</div>}
                    </div>
                    
                    <div className="toolbar">
                        {toolbarItems.map((item) => (
                            <div key={item.id} 
                                className={`tool-btn ${(item.id === 'lang' && showLangMenu) || (item.id === 'aiName' && showAiNameInput) || (item.id === 'userName' && showUserNameInput) ? 'active' : ''}`}
                                onClick={() => {
                                    if (item.id === 'lang') { closeAllMenus(); setShowLangMenu(!showLangMenu); }
                                    else if (item.id === 'aiName') { closeAllMenus(); setShowAiNameInput(!showAiNameInput); setTempName(aiName); }
                                    else if (item.id === 'userName') { closeAllMenus(); setShowUserNameInput(!showUserNameInput); setTempName(userName); }
                                    else if (item.id === 'reset') { resetConversation(); }
                                }}>
                                {item.emoji ? <span className="emoji">{item.emoji}</span> : <svg viewBox="0 0 24 24"><path d={item.icon}/></svg>}
                                <span className="tooltip">{item.tip}</span>
                                
                                {item.id === 'lang' && (
                                    <div className={`dropdown-menu ${showLangMenu ? 'show' : ''}`} onClick={e => e.stopPropagation()}>
                                        <div className={`dropdown-item ${lang === 'en' ? 'active' : ''}`} onClick={() => { setLang('en'); setShowLangMenu(false); }}>English</div>
                                        <div className={`dropdown-item ${lang === 'zh-TW' ? 'active' : ''}`} onClick={() => { setLang('zh-TW'); setShowLangMenu(false); }}>ÁπÅÈ´î‰∏≠Êñá</div>
                                    </div>
                                )}
                                
                                {item.id === 'aiName' && (
                                    <div className={`dropdown-menu name-input-popup ${showAiNameInput ? 'show' : ''}`} onClick={e => e.stopPropagation()}>
                                        <label>AI Name</label>
                                        <input value={tempName} onChange={e => setTempName(e.target.value)} 
                                            onKeyPress={e => { if (e.key === 'Enter' && tempName.trim()) { setAiName(tempName.trim()); setShowAiNameInput(false); }}} />
                                        <button onClick={() => { if (tempName.trim()) setAiName(tempName.trim()); setShowAiNameInput(false); }}>{t.save}</button>
                                    </div>
                                )}
                                
                                {item.id === 'userName' && (
                                    <div className={`dropdown-menu name-input-popup ${showUserNameInput ? 'show' : ''}`} onClick={e => e.stopPropagation()}>
                                        <label>Your Name</label>
                                        <input value={tempName} onChange={e => setTempName(e.target.value)}
                                            onKeyPress={e => { if (e.key === 'Enter' && tempName.trim()) { setUserName(tempName.trim()); setShowUserNameInput(false); }}} />
                                        <button onClick={() => { if (tempName.trim()) setUserName(tempName.trim()); setShowUserNameInput(false); }}>{t.save}</button>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                    
                    <div className="cat-mascot">{CAT_EMOTIONS[catEmotion]}</div>
                    
                    <div className="chat-area" ref={chatAreaRef}>
                        {messages.map((msg, i) => (
                            <div key={i} className={`message ${msg.role}`}>{msg.content}</div>
                        ))}
                        {isLoading && <div className="message ai"><div className="loading"><span></span><span></span><span></span></div></div>}
                        {generatedDiary && !showDiaryModal && (
                            <button className="diary-ready-btn" onClick={() => setShowDiaryModal(true)}>
                                {t.viewDiary}
                            </button>
                        )}
                    </div>
                    
                    {showDiaryModal && (
                        <div className="diary-modal" onClick={() => setShowDiaryModal(false)}>
                            <div className="diary-book" onClick={e => e.stopPropagation()}>
                                <div className="diary-header">
                                    <h2>‚ú¶ ¬∑ ‚ú¶ ¬∑ ‚ú¶</h2>
                                    <button className="diary-close" onClick={() => setShowDiaryModal(false)}>√ó</button>
                                </div>
                                <div className="diary-content">
                                    <div className="diary-page">
                                        <h3>{t.myDiary}</h3>
                                        <p>{generatedDiary}</p>
                                        <button className="copy-btn" onClick={() => copyToClipboard(generatedDiary)}>üìã</button>
                                    </div>
                                    <div className="diary-page">
                                        <h3 className="ai-title">{t.aiLetter(aiName)}</h3>
                                        <p>{aiReverseDiary}</p>
                                        <button className="copy-btn" onClick={() => copyToClipboard(aiReverseDiary)}>üìã</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div className="input-area">
                        <div className="input-container">
                            <input type="text" placeholder={isRecording ? t.listening : t.placeholder}
                                value={inputText} onChange={(e) => setInputText(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && sendMessage()} disabled={isLoading || isSpeaking} />
                        </div>
                        <button className={`mic-btn ${isRecording ? 'recording' : ''}`} onClick={toggleRecording} disabled={isLoading || isSpeaking}>
                            <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg>
                        </button>
                        <button className="send-btn" onClick={sendMessage} disabled={isLoading || !inputText.trim()}>
                            <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                    </div>
                </div>
            );
        }
        ReactDOM.render(<VoiceDiary />, document.getElementById('root'));
    </script>
</body>
</html>
